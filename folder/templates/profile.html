<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaTL - Хэрэглэгчийн профайл</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
.container {
    max-width: 1200px;
    margin: 40px auto 0 auto;
    display: flex;
    gap: 32px;
    align-items: flex-start;
    width: 100%;
    box-sizing: border-box;
}
@media (max-width: 1300px) {
    .container {
        max-width: 98vw;
        padding-left: 8px;
        padding-right: 8px;
    }
}
@media (max-width: 900px) {
    .container {
        flex-direction: column;
        gap: 24px;
        max-width: 100vw;
        padding: 0 4px;
    }
}
    </style>
</head>
<body style="background:#f8fafc;">
     <div class="header">
        <div class="logo">MaTL</div>
        <nav class="main-nav">
            <a href="/" class="active">Нүүр</a>
            <a href="/preschool">Цэцэрлэг</a>
        </nav>
        <div class="login" id="loginArea">
            <!-- Login/Register or Username will be rendered here by JS -->
        </div>
    </div>
    <div class="container">
        <!-- Left Sidebar: Profile Card -->
        <div style="flex:0 0 320px; background:linear-gradient(135deg,#e3f2fd 60%,#b6f0d4 100%); border-radius:18px; box-shadow:0 4px 24px rgba(56,142,224,0.10); padding:36px 24px 28px 24px; display:flex; flex-direction:column; align-items:center; position:relative; overflow:hidden;">
            <div style="width:112px; height:112px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; font-size:2.2rem; color:#b7a47a; font-weight:600; margin-bottom:12px; box-shadow:0 2px 12px #b3e5fc; position:relative;">
                <img id="profileAvatar" src="/static/img/profile-default.svg" alt="Profile" style="width:100px; height:100px; border-radius:50%; background:#e3eaf6; object-fit:cover; cursor:pointer; border:3px solid #b6f0d4;">
                <input type="file" id="avatarInput" style="display:none;">
            </div>
            <div id="profileUsername" style="font-size:1.22rem; font-weight:700; color:#1976d2; margin-bottom:2px; letter-spacing:0.5px;">@abc <span id="adminBadge" style="display:none; background:#ffeaea; color:#d32f2f; font-size:0.95rem; font-weight:600; border-radius:6px; padding:2px 10px; margin-left:8px; vertical-align:middle;">Админ</span></div>
            <div id="profileEmail" style="color:#388eea; font-size:1rem; margin-bottom:18px;">abc@email.com</div>
            <div style="width:100%; border-top:1px solid #e0e0e0; margin:18px 0 14px 0;"></div>
            <div style="width:100%; display:flex; flex-direction:column; gap:10px; font-size:1.08rem; color:#444;">
                <div style="display:flex; align-items:center; justify-content:space-between;"><span>Оноо</span><span id="profilePoints" style="font-weight:700; color:#b7a47a; font-size:1.15rem;">0</span></div>
                <div style="display:flex; align-items:center; justify-content:space-between;"><span>Асуулд оролцсон</span><span id="profileQuestions" style="font-weight:600;">0</span></div>
                <div style="display:flex; align-items:center; justify-content:space-between;"><span>Асуулд дуусгасан</span><span id="profileCompleted" style="font-weight:600;">0</span></div>
                <div style="display:flex; align-items:center; justify-content:space-between;"><span>Гүйцэтгэлийн хувь</span><span id="profilePercent" style="font-weight:600; color:#388eea;">0.0%</span></div>
            </div>
            <button id="sidebarSettingsBtn" class="login-btn" style="width:100%; margin-top:22px; background:#fff; color:#388eea; border:1.5px solid #388eea; border-radius:8px; font-weight:700; font-size:1.08rem;">Профайлын тохиргоо</button>
        </div>
        <!-- Right Main Content -->
        <div style="flex:1; min-width:0;">
            <!-- Tab Navigation -->
            <div style="display:flex; gap:10px; background:#f5f7fa; border-radius:12px; padding:8px 10px; margin-bottom:28px; box-shadow:0 1px 4px rgba(56,142,224,0.04);">
                <button class="tab-btn active" style="background:#fff; color:#1976d2; font-weight:700; border:none; border-radius:8px; padding:10px 28px; cursor:pointer; box-shadow:0 1px 4px rgba(56,142,224,0.04); transition:background 0.2s, color 0.2s;">Тойм</button>
                <button class="tab-btn" style="background:none; color:#555; font-weight:600; border:none; border-radius:8px; padding:10px 28px; cursor:pointer; transition:background 0.2s, color 0.2s;">Илгээмжүүд</button>
                <button class="tab-btn" style="background:none; color:#555; font-weight:600; border:none; border-radius:8px; padding:10px 28px; cursor:pointer; transition:background 0.2s, color 0.2s;">Ахиц дэвшил</button>
                <button class="tab-btn" style="background:none; color:#555; font-weight:600; border:none; border-radius:8px; padding:10px 28px; cursor:pointer; transition:background 0.2s, color 0.2s;">Оноо</button>
                <button class="tab-btn" style="background:none; color:#555; font-weight:600; border:none; border-radius:8px; padding:10px 28px; cursor:pointer; transition:background 0.2s, color 0.2s;">Тохиргоо</button>
            </div>
            <!-- Overview Tab Content -->
            <div id="overviewTab" style="display:block;">
                <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:28px 24px; margin-bottom:24px;">
                    <h2 style="font-size:1.2rem; color:#222; font-weight:600; margin-bottom:18px;">Таны сургалтын хураангуй</h2>
                    <div style="color:#888; font-size:1rem; margin-bottom:8px;">Ерөнхий ахиц дэвшил</div>
                    <div style="background:#e3eaf6; border-radius:8px; height:16px; width:100%; position:relative; margin-bottom:8px;">
                        <div id="progressFill" style="background:#388eea; height:16px; border-radius:8px; width:0%; transition:width 0.5s;"></div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; color:#222; font-weight:600; font-size:1rem; margin-bottom:10px;"><span id="progressText">0.0%</span></div>
                    <div style="font-weight:600; color:#222; margin-bottom:6px;">Сүүлийн үеийн ололт амжилт</div>
                    <div style="color:#888; font-size:1rem;">Амжилт олохын тулд бодлогуудыг бод!</div>
                </div>
                <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:28px 24px;">
                    <h2 style="font-size:1.2rem; color:#222; font-weight:600; margin-bottom:18px;">Таны математикийн сэдвүүд</h2>
                    <div style="color:#888; font-size:1rem;">Одоогоор сэдэв эхлээгүй байна!</div>
                </div>
                <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:28px 24px; margin-bottom:24px;">
                    <h2 style="font-size:1.2rem; color:#222; font-weight:600; margin-bottom:18px;">Шийдсэн бодлогууд</h2>
                    <ul id="solvedProblemsList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
            </div>
            <!-- Илгээмжүүд Tab Content -->
            <div id="submissionsTab" style="display:none;">
              <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:28px 24px; margin-bottom:24px;">
                <h2 style="font-size:1.35rem; color:#222; font-weight:700; margin-bottom:8px;">Таны илгээмжүүд</h2>
                <div style="color:#888; font-size:1rem; margin-bottom:18px;">Сүүлийн үеийн бодлого болон шийдлүүдийг харна уу</div>
                <!-- Submission Card 1 -->
                <div style="border:1.5px solid #e3eaf6; border-radius:10px; padding:18px 20px; margin-bottom:16px; background:#fcfdff;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div style="font-size:1.13rem; font-weight:700; color:#222;">Шугаман тэгшитгэлийг шийдвэрлэх: 7x - 14 = 35</div>
                    <span style="background:#8ad16d; color:#222; border-radius:7px; padding:4px 16px; font-size:1rem; font-weight:600;">Зөв</span>
                  </div>
                  <div style="color:#888; font-size:0.98rem; margin-bottom:6px;">Шугаман тэгшитгэл · 2 хоногийн өмнө оруулсан</div>
                  <div style="color:#444; font-size:1rem; margin-bottom:8px;"><b>Таны хариулт:</b></div>
                  <div style="background:#f8fafc; border-radius:7px; padding:10px 16px; font-size:1.08rem; color:#222;">x = 7</div>
                </div>
                <!-- Submission Card 2 -->
                <div style="border:1.5px solid #e3eaf6; border-radius:10px; padding:18px 20px; margin-bottom:16px; background:#fcfdff;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div style="font-size:1.13rem; font-weight:700; color:#222;">Гурвалжны талбайг ол</div>
                    <span style="background:#8ad16d; color:#222; border-radius:7px; padding:4px 16px; font-size:1rem; font-weight:600;">Зөв</span>
                  </div>
                  <div style="color:#888; font-size:0.98rem; margin-bottom:6px;">Геометр, Гурвалжин · 1 долоо хоногийн өмнө оруулсан</div>
                  <div style="color:#444; font-size:1rem; margin-bottom:8px;"><b>Таны хариулт:</b></div>
                  <div style="background:#f8fafc; border-radius:7px; padding:10px 16px; font-size:1.08rem; color:#222;">A = 20 см²</div>
                </div>
                <div style="color:#888; font-size:0.98rem; text-align:right; margin-top:10px;">5 модулиас 2-ыг харуулж байна</div>
                <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                  <button style="background:#fff; color:#388eea; border:1.5px solid #e3eaf6; border-radius:7px; padding:8px 18px; font-size:1rem; font-weight:600; cursor:pointer;">Бүгдийг харах</button>
                </div>
              </div>
            </div>
            <!-- Settings Tab Content -->
            <div id="settingsTab" style="display:none;">
                <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:32px 32px 28px 32px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:18px;">
                        <span style="font-size:1.5rem; color:#5aa4b1;">✎</span>
                        <h2 style="font-size:1.35rem; color:#222; font-weight:700; margin:0;">Профайлын тохиргоо</h2>
                    </div>
                    <div style="margin-bottom:28px;">
                        <div style="font-size:1.1rem; font-weight:600; color:#222; margin-bottom:4px;">Профайл мэдээлэл</div>
                        <div style="color:#888; font-size:1rem; margin-bottom:18px;">Бүртгэлийнхээ профайлын мэдээллийг шинэчлэх.</div>
                        <form id="profileSettingsForm" style="display:grid; grid-template-columns:1fr 1fr; gap:24px 32px; align-items:end;">
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <label for="displayName" style="font-weight:500; color:#222;">Дэлгэцийн нэр</label>
                                <input id="displayName" name="displayName" type="text" placeholder="Your display name" style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <label for="username" style="font-weight:500; color:#222;">Хэрэглэгчийн нэр</label>
                                <input id="username" name="username" type="text" value="abc" readonly style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem; background:#f7f7f7; color:#888;">
                                <span style="font-size:0.95rem; color:#b0b0b0;">Хэрэглэгчийн нэрийг өөрчлөх боломжгүй</span>
                            </div>
                            <div style="grid-column:1/3; display:flex; flex-direction:column; gap:8px;">
                                <label for="bio" style="font-weight:500; color:#222;">Bio</label>
                                <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself" style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem;"></textarea>
                            </div>
                            <div style="grid-column:1/3; display:flex; justify-content:flex-end; margin-top:8px;">
                                <button type="submit" style="background:#5aa4b1; color:#fff; border:none; border-radius:7px; padding:10px 28px; font-size:1.08rem; font-weight:600; cursor:pointer;">Өөрчлөлтүүдийг хадгалах</button>
                            </div>
                        </form>
                    </div>
                    <div style="border-top:1px solid #eee; margin:24px 0 18px 0;"></div>
                    <div style="font-size:1.1rem; font-weight:600; color:#222; margin-bottom:4px;">Аюулгүй байдлын тохиргоо</div>
                    <div style="color:#888; font-size:1rem; margin-bottom:18px;">Бүртгэлийнхээ аюулгүй байдлын тохиргоог удирдах.</div>
                    <button id="changePasswordBtn" style="background:#fff; color:#5aa4b1; border:1.5px solid #5aa4b1; border-radius:7px; padding:10px 28px; font-size:1.08rem; font-weight:600; cursor:pointer;">Нууц үг солих</button>
                    <div id="changePasswordModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:9999; align-items:center; justify-content:center;">
                      <div style="background:#fff; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.13); padding:32px 28px; min-width:320px; max-width:90vw;">
                        <h3 style="margin-top:0; color:#5aa4b1; font-size:1.15rem; font-weight:700;">Нууц үг солих</h3>
                        <form id="changePasswordForm" style="display:flex; flex-direction:column; gap:16px;">
                          <input type="password" id="currentPassword" placeholder="Одоогийн нууц үг" style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem;">
                          <input type="password" id="newPassword" placeholder="Шинэ нууц үг" style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem;">
                          <input type="password" id="confirmPassword" placeholder="Шинэ нууц үг давтах" style="padding:10px 12px; border:1px solid #e0e0e0; border-radius:7px; font-size:1rem;">
                          <div id="changePasswordError" style="color:#d32f2f; font-size:0.98rem; min-height:18px;"></div>
                          <div style="display:flex; gap:10px; justify-content:flex-end;">
                            <button type="button" id="cancelChangePassword" style="background:#eee; color:#444; border:none; border-radius:7px; padding:8px 18px; font-size:1rem; cursor:pointer;">Болих</button>
                            <button type="submit" style="background:#5aa4b1; color:#fff; border:none; border-radius:7px; padding:8px 18px; font-size:1rem; font-weight:600; cursor:pointer;">Хадгалах</button>
                          </div>
                        </form>
                      </div>
                    </div>
                </div>
            </div>
            <!-- Оноо Tab Content -->
            <div id="pointsTab" style="display:none;">
              <div style="background:#fff; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); padding:28px 24px; margin-bottom:24px;">
                <h2 style="font-size:1.35rem; color:#222; font-weight:700; margin-bottom:8px;">Таны оноо</h2>
                <div style="color:#888; font-size:1rem; margin-bottom:18px;">Таны авсан нийт оноо болон онооны дэлгэрэнгүй жагсаалт.</div>
                <div style="display:flex; align-items:center; gap:18px; margin-bottom:24px;">
                  <div style="background:#f8fafc; border-radius:12px; padding:24px 36px; font-size:2.2rem; font-weight:700; color:#b7a47a; box-shadow:0 1px 4px rgba(0,0,0,0.04);">0</div>
                  <div style="font-size:1.1rem; color:#444;">Нийт оноо</div>
                </div>
                <div style="font-size:1.08rem; font-weight:600; color:#222; margin-bottom:10px;">Онооны түүх</div>
                <table style="width:100%; border-collapse:collapse; background:#fcfdff; border-radius:10px; overflow:hidden;">
                  <thead>
                    <tr style="background:#f5f7fa; color:#888; font-size:1rem;">
                      <th style="padding:10px 8px; text-align:left; font-weight:600;">Огноо</th>
                      <th style="padding:10px 8px; text-align:left; font-weight:600;">Тайлбар</th>
                      <th style="padding:10px 8px; text-align:right; font-weight:600;">Оноо</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="padding:10px 8px; color:#444;">2025-06-01</td>
                      <td style="padding:10px 8px; color:#444;">Бодлого амжилттай шийдсэн</td>
                      <td style="padding:10px 8px; color:#388eea; text-align:right; font-weight:700;">+10</td>
                    </tr>
                    <tr>
                      <td style="padding:10px 8px; color:#444;">2025-05-30</td>
                      <td style="padding:10px 8px; color:#444;">Шинэ сэдэв эхэлсэн</td>
                      <td style="padding:10px 8px; color:#388eea; text-align:right; font-weight:700;">+5</td>
                    </tr>
                    <tr>
                      <td style="padding:10px 8px; color:#444;">2025-05-28</td>
                      <td style="padding:10px 8px; color:#444;">Өдөр тутмын урамшуулал</td>
                      <td style="padding:10px 8px; color:#388eea; text-align:right; font-weight:700;">+2</td>
                    </tr>
                  </tbody>
                </table>
                <div style="color:#888; font-size:0.98rem; text-align:right; margin-top:10px;">10 бичлэгээс 3-ыг харуулж байна</div>
              </div>
            </div>
            <script>
            // Check login status via a simple fetch to /api/user
            fetch('/api/user').then(r=>r.json()).then(data => {
                const loginArea = document.getElementById('loginArea');
                if(data.username) {
                    loginArea.innerHTML = `
                    <div class="user-dropdown" style="position:relative; display:inline-block;">
                        <button id="userDropdownBtn" class="login-btn" style="font-weight:bold;color:#388eea; background:#fff; border:1px solid #388eea; border-radius:8px; padding:10px 18px; display:flex; align-items:center; gap:8px;">
                            <span style="font-size:1.1rem;">${data.username}</span>
                            <span style="font-size:1.1rem;">▼</span>
                        </button>
                        <div id="userDropdownMenu" style="display:none; position:absolute; right:0; top:44px; background:#fff; box-shadow:0 4px 24px rgba(0,0,0,0.10); border-radius:12px; min-width:240px; z-index:100; margin-top:8px; padding:0;">
                            <div style="padding:16px 20px 10px 20px; border-bottom:1px solid #f0f0f0;">
                                <div style="font-weight:bold; font-size:1.1rem; color:#222;">${data.username}</div>
                                <div style="font-size:0.97rem; color:#388eea;">${data.email || ''}</div>
                            </div>
                            <a href="/profile" style="display:flex; align-items:center; gap:10px; padding:12px 20px; color:#222; text-decoration:none; font-size:1rem; border-bottom:1px solid #f0f0f0;">
                                <span style="font-size:1.2rem;">&#128100;</span> Профайл
                            </a>
                            <a href="/settings" style="display:flex; align-items:center; gap:10px; padding:12px 20px; color:#222; text-decoration:none; font-size:1rem; border-bottom:1px solid #f0f0f0;">
                                <span style="font-size:1.2rem;">&#9881;</span> Тохиргоо
                            </a>
                            <a href="/admin" id="adminDashboardLink" style="display:none; align-items:center; gap:10px; padding:12px 20px; color:#d32f2f; text-decoration:none; font-size:1rem; border-bottom:1px solid #f0f0f0;">
                                <span style="font-size:1.2rem;">&#128295;</span> Админ
                            </a>
                            <a href="/logout" style="display:flex; align-items:center; gap:10px; padding:12px 20px; color:#d32f2f; text-decoration:none; font-size:1rem;">
                                <span style="font-size:1.2rem;">&#8617;</span> Гарах
                            </a>
                        </div>
                    </div>`;
                    // Dropdown logic
                    const btn = document.getElementById('userDropdownBtn');
                    const menu = document.getElementById('userDropdownMenu');
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    });
                    document.addEventListener('click', function(e) {
                        if (!menu.contains(e.target) && e.target !== btn) {
                            menu.style.display = 'none';
                        }
                    });
                    document.getElementById('profileUsername').textContent = '@' + data.username;
                    document.getElementById('profileEmail').textContent = data.email || '';
                    // Show admin badge if admin
                    if(data.isAdmin) {
                        const badge = document.getElementById('adminBadge');
                        if(badge) badge.style.display = 'inline-block';
                        // Add admin link to dropdown
                        const adminLink = document.getElementById('adminDashboardLink');
                        if(adminLink) adminLink.style.display = 'flex';
                    }
                    // Avatar initials
                    let initials = (data.username||'').slice(0,2).toUpperCase();
                    document.getElementById('avatarInitials').textContent = initials;
                    // User Progress Tracking
                    fetch('/api/progress').then (r=>r.json()).then(progress => {
                        let percent = 0;
                        let total = 0;
                        let completed = 0;
                        let points = 0;
                        let questions = 0;
                        let finished = 0;
                        if(progress && Object.keys(progress).length) {
                            total = Object.keys(progress).length;
                            completed = Object.values(progress).filter(p=>p.score>=80).length;
                            percent = ((completed/total)*100).toFixed(1);
                            points = Object.values(progress).reduce((a,b)=>a+(b.score||0),0);
                            questions = Object.values(progress).reduce((a,b)=>a+(b.questionsAnswered||0),0);
                            finished = completed;
                        }
                        document.getElementById('progressFill').style.width = percent + '%';
                        document.getElementById('progressText').textContent = percent + '%';
                        document.getElementById('profilePoints').textContent = points;
                        document.getElementById('profileQuestions').textContent = questions;
                        document.getElementById('profileCompleted').textContent = finished;
                        document.getElementById('profilePercent').textContent = percent + '%';
                    });
                    // Profile Customization: Avatar upload (client only)
                    const avatar = document.getElementById('profileAvatar');
                    const avatarInput = document.getElementById('avatarInput');
                    avatar.onclick = ()=>avatarInput.click();
                    avatarInput.onchange = function() {
                        const file = this.files[0];
                        if(file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                avatar.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                } else {
                    loginArea.innerHTML = `<a href="/login"><button class="login-btn">Нэвтрэх</button></a> <a href="/register"><button class="login-btn" style="background:#fff;color:#388eea;border:1px solid #388eea;margin-left:8px;">Бүртгүүлэх</button></a>`;
                    document.getElementById('profileUsername').textContent = 'Зочин';
                    document.getElementById('profileEmail').textContent = '';
                    document.getElementById('avatarInitials').textContent = 'AB';
                }
            });
            // Tab switching logic
            const tabBtns = document.querySelectorAll('.tab-btn');
            const overviewTab = document.getElementById('overviewTab');
            const submissionsTab = document.getElementById('submissionsTab');
            const settingsTab = document.getElementById('settingsTab');
            const pointsTab = document.getElementById('pointsTab');
            tabBtns.forEach((btn, idx) => {
                btn.addEventListener('click', function() {
                    tabBtns.forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    if(idx === tabBtns.length-1) { // Settings
                        overviewTab.style.display = 'none';
                        submissionsTab.style.display = 'none';
                        settingsTab.style.display = 'block';
                        pointsTab.style.display = 'none';
                    } else if (idx === 1) { // Submissions
                        overviewTab.style.display = 'none';
                        settingsTab.style.display = 'none';
                        submissionsTab.style.display = 'block';
                        pointsTab.style.display = 'none';
                    } else if (idx === 3) { // Points
                        overviewTab.style.display = 'none';
                        settingsTab.style.display = 'none';
                        submissionsTab.style.display = 'none';
                        pointsTab.style.display = 'block';
                    } else {
                        overviewTab.style.display = 'block';
                        settingsTab.style.display = 'none';
                        submissionsTab.style.display = 'none';
                        pointsTab.style.display = 'none';
                    }
                });
            });
            // Add sidebar settings button logic to switch to the settings tab
            const sidebarSettingsBtn = document.getElementById('sidebarSettingsBtn');
            if (sidebarSettingsBtn) {
                sidebarSettingsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabBtns = document.querySelectorAll('.tab-btn');
                    const overviewTab = document.getElementById('overviewTab');
                    const settingsTab = document.getElementById('settingsTab');
                    tabBtns.forEach(b=>b.classList.remove('active'));
                    tabBtns[tabBtns.length-1].classList.add('active'); // Last tab is settings
                    overviewTab.style.display = 'none';
                    settingsTab.style.display = 'block';
                    submissionsTab.style.display = 'none';
                    pointsTab.style.display = 'none';
                    // Scroll to top of main content if needed
                    settingsTab.scrollIntoView({behavior:'smooth', block:'start'});
                });
            }
            // Change password modal logic
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const changePasswordModal = document.getElementById('changePasswordModal');
            const cancelChangePassword = document.getElementById('cancelChangePassword');
            const changePasswordForm = document.getElementById('changePasswordForm');
            const changePasswordError = document.getElementById('changePasswordError');
            if (changePasswordBtn && changePasswordModal) {
              changePasswordBtn.onclick = () => { changePasswordModal.style.display = 'flex'; };
              cancelChangePassword.onclick = () => { changePasswordModal.style.display = 'none'; changePasswordError.textContent = ''; };
              changePasswordForm.onsubmit = async function(e) {
                e.preventDefault();
                const current = document.getElementById('currentPassword').value;
                const next = document.getElementById('newPassword').value;
                const confirm = document.getElementById('confirmPassword').value;
                const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                if (!current || !next || !confirm) {
                  changePasswordError.style.color = '#d32f2f';
                  changePasswordError.textContent = 'Бүх талбарыг бөглөнө үү.';
                  if (submitBtn) submitBtn.disabled = false;
                  return;
                }
                if (next !== confirm) {
                  changePasswordError.style.color = '#d32f2f';
                  changePasswordError.textContent = 'Шинэ нууц үг таарахгүй байна.';
                  if (submitBtn) submitBtn.disabled = false;
                  return;
                }
                changePasswordError.style.color = '#888';
                changePasswordError.textContent = 'Хадгалж байна...';
                // Call backend API
                try {
                  const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: current, newPassword: next })
                  });
                  const result = await res.json();
                  if (result.success) {
                    changePasswordError.style.color = '#388eea';
                    changePasswordError.textContent = 'Амжилттай солигдлоо!';
                    setTimeout(()=>{ changePasswordModal.style.display = 'none'; changePasswordError.textContent = ''; changePasswordError.style.color = '#d32f2f'; }, 1200);
                  } else {
                    changePasswordError.style.color = '#d32f2f';
                    changePasswordError.textContent = result.error || 'Алдаа гарлаа.';
                  }
                } catch (err) {
                  changePasswordError.style.color = '#d32f2f';
                  changePasswordError.textContent = 'Сервертэй холбогдож чадсангүй.';
                }
                if (submitBtn) submitBtn.disabled = false;
              };
            }
            // Profile settings form submit logic
            const profileSettingsForm = document.getElementById('profileSettingsForm');
            if (profileSettingsForm) {
              profileSettingsForm.onsubmit = async function(e) {
                e.preventDefault();
                const displayName = document.getElementById('displayName').value;
                const bio = document.getElementById('bio').value;
                const submitBtn = profileSettingsForm.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                let feedback = document.getElementById('profileSettingsFeedback');
                if (!feedback) {
                  feedback = document.createElement('div');
                  feedback.id = 'profileSettingsFeedback';
                  feedback.style.marginTop = '10px';
                  feedback.style.fontSize = '1rem';
                  profileSettingsForm.appendChild(feedback);
                }
                feedback.style.color = '#888';
                feedback.textContent = 'Хадгалж байна...';
                try {
                  const res = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName, bio })
                  });
                  const result = await res.json();
                  if (result.success) {
                    feedback.style.color = '#388eea';
                    feedback.textContent = 'Амжилттай хадгалагдлаа!';
                  } else {
                    feedback.style.color = '#d32f2f';
                    feedback.textContent = result.error || 'Алдаа гарлаа.';
                  }
                } catch (err) {
                  feedback.style.color = '#d32f2f';
                  feedback.textContent = 'Сервертэй холбогдож чадсангүй.';
                }
                if (submitBtn) submitBtn.disabled = false;
              };
            }
            // Show solved problems in profile
            fetch('/api/solved').then(r=>r.json()).then(ids => {
                if(!ids || !ids.length) return;
                fetch('/api/problems/latest').then(r=>r.json()).then(problems => {
                    const list = document.getElementById('solvedProblemsList');
                    if (!list) return;
                    const solved = problems.filter(p => ids.includes(p._id));
                    if (!solved.length) {
                        list.innerHTML = '<li style="color:#888;">Шийдсэн бодлого алга</li>';
                        return;
                    }
                    list.innerHTML = solved.map(p => `<li style="margin-bottom:10px; background:#e3f2fd; border-radius:8px; padding:10px 16px; font-weight:600; color:#1976d2;">${p.title}</li>`).join('');
                });
            });
            </script>
        </div>
    </div>
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Математик бодлого</h3>
                <p>Математикийг хүн бүрт хүртээмжтэй, ойлгомжтой, хөгжилтэй болгох.</p>
            </div>
            <div class="footer-section">
                <h3>Холбоо барих</h3>
                <ul class="footer-contact">
                    <li><span class="footer-icon">&#9993;</span> Matl@edu.mn</li>
                    <li><span class="footer-icon">&#128205;</span> Чингэлтэй дүүрэг 1-р хороо, 1-р хороолол 1-р байр 1 давхар </li>
                </ul>
            </div>
        </div>
        <hr style="border:1px solid #3a4252; margin:32px 0 16px 0;">
        <div class="footer-bottom">
            <div class="footer-copyright">
                © 2025 МАТЕМАТИК БОЛОВСРОЛЫН ТӨВ
            </div>
            <div class="footer-social">
                <a href="#"><img src="/static/img/instagram.svg" alt="Instagram" height="28"></a>
                <a href="#"><img src="/static/img/youtube.svg" alt="YouTube" height="28"></a>
                <a href="#"><img src="/static/img/facebook.svg" alt="Facebook" height="28"></a>
            </div>
        </div>
    </footer>
</body>
</html>
